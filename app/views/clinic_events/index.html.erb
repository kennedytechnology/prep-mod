<div class="clinic-events-page">
    <div class="card-wrapper">
      <div class="card-header">
        <h3>Clinic Activity Form</h3>
        <div class="links-buttons">
          <%= link_to "Registration List", clinic_patients_path(clinic_id: @clinic.id), class: "clinic-action" %>
          <%= link_to "Edit Clinic", edit_clinic_path(id: @clinic.id), class: "clinic-action" %>
        </div>
      </div>

      <div class="details-section">
        <h3>Clinic Date: <%= @clinic.clinic_date %></h3>
        <h3>County: <%= @clinic.address.split(',')[1] %></h3>
        <h3>Location: <%= @clinic.address %></h3>
        <h3>Lead Tester's Name: <%= @clinic.lead_vaccinator_name %> </h3>
      </div>

      <div class="card-content">
        <%= form_with(model: @clinic, url: clinic_path(@clinic), method: :put) do |f| %>
          <div class="flex mb-4">
            <div class="w-4/12 mr-4">
              <%= f.label :start_time, "Clinic Start Time:", class: "mr-3 font-bold" %><br/>
              <select class="form-select transition duration-150 ease-in-out sm:text-sm sm:leading-5" name="clinic[start_hour]">
                  <%= options_for_select((1..12).to_a, @clinic.start_time ? @clinic.start_time.strftime('%l').to_i : nil) %>
              </select>
              <span class="colon">:</span>
              <select class="form-select transition duration-150 ease-in-out sm:text-sm sm:leading-5" name="clinic[start_minute]" >
                  <%= options_for_select(['00', '15', '30', '45'], @clinic.start_time ? @clinic.start_time.strftime('%M').to_i : nil) %>
              </select>
              <select class="form-select transition duration-150 ease-in-out sm:text-sm sm:leading-5" name="clinic[start_meridiem]" >
                  <%= options_for_select(['AM', 'PM'], @clinic.start_time ? @clinic.start_time.strftime('%p') : nil) %>
              </select>
            </div>
            <div class="w-4/12 mr-4">
              <%= f.label :end_time, "Clinic End Time:", class: "mr-3 font-bold" %><br/>
              <select class="form-select transition duration-150 ease-in-out sm:text-sm sm:leading-5" name="clinic[end_hour]">
                  <%= options_for_select((1..12).to_a, @clinic.end_time ? @clinic.end_time.strftime('%l').to_i : nil) %>
              </select>
              <span class="colon">:</span>
              <select class="form-select transition duration-150 ease-in-out sm:text-sm sm:leading-5" name="clinic[end_minute]" >
                  <%= options_for_select(['00', '15', '30', '45'], @clinic.end_time ? @clinic.end_time.strftime('%M').to_i : nil) %>
              </select>
              <select class="form-select transition duration-150 ease-in-out sm:text-sm sm:leading-5" name="clinic[end_meridiem]" >
                  <%= options_for_select(['AM', 'PM'], @clinic.end_time ? @clinic.end_time.strftime('%p') : nil) %>
              </select>
            </div>
            <div class="w-4/12">
              <label>Clinic Length (in minutes)</label>:
              <input type="text" placeholder="315" value="<%= (@clinic.end_time.to_i - @clinic.start_time.to_i) / 60 %>" disabled>
            </div>
          </div>

          <div class="clinic-comments">
            <%= f.label :incidents_comments, "Clinic Incidents or Comments", class: "form-group-label" %>
            <%= f.text_area :incidents_comments %>
          </div>

          <div class="tests-table-section">
            <div class="add-more-tests-button-container">
              <%= link_to sanitize("Add More Test &#43;"), "#", class: "add-more-tests-button" %>
            </div>
            <div class="tests-table-outer">
              <div class="tests-table-wrapper">
                <div class="tests-table-container">
                  <table class="tests-table">
                    <thead>
                    <tr>
                      <th>Test Name</th>
                      <th># Lot Number</th>
                      <th># of Starting Kits</th>
                      <th># Tests Administered</th>
                      <th># Unusable Tests</th>
                      <th># Tests Returned</th>
                      <th>Default</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                      <td><input type="text" value="Fluzone"></td>
                      <td><input type="text" value=2392></td>
                      <td><input type="text" value=200></td>
                      <td><input type="text" value=100></td>
                      <td><input type="text" value=10></td>
                      <td><input type="text" value=10></td>
                      <td>
                        <div class="flex">
                          <%= link_to "Yes", "#", class: "table-actions" %>
                          <%= link_to "No", "#", class: "table-actions" %>
                        </div>
                      </td>
                    </tr>
                    <tr>
                      <td><input type="text" value="Flu Test One"></td>
                      <td><input type="text"  value=2393></td>
                      <td><input type="text"  value=100></td>
                      <td><input type="text"  value=50></td>
                      <td><input type="text"  value=10></td>
                      <td><input type="text"  value=10></td>
                      <td>
                        <div class="flex">
                          <%= link_to "Yes", "#", class: "table-actions" %>
                          <%= link_to "No", "#", class: "table-actions" %>
                        </div>
                      </td>
                    </tr>
                    <tr>
                      <td><input type="text" value="Flu Test Two"></td>
                      <td><input type="text" value=2394></td>
                      <td><input type="text" value=100></td>
                      <td><input type="text" value=50></td>
                      <td><input type="text" value=10></td>
                      <td><input type="text" value=10></td>
                      <td>
                        <div class="flex">
                          <%= link_to "Yes", "#", class: "table-actions" %>
                          <%= link_to "No", "#", class: "table-actions" %>
                        </div>
                      </td>
                    </tr>
                    </tbody>
                    <tfoot>
                    <tr>
                      <td>TOTALS:</td>
                      <td></td>
                      <td>400</td>
                      <td>200</td>
                      <td>30</td>
                      <td>30</td>
                    </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="patients-table-section" data-controller="clinic-activity-patients">

           

            <div class="patients-table-header">
              <div class="search-section">
                <label for="search">Search: </label>
                <input id="search" data-action="keyup->clinic-activity-patients#search" type="text">
              </div>
              <div class="add-more-patients">
                <%= link_to sanitize("Add More Patients &#43;"), "/patients/new", class: "add-more-patients-button" %>
              </div>
            </div>
            <div class="patients-table-outer">
              <div class="patients-table-wrapper">
                <div class="patients-table-container">
                  <table class="patients-table">
                    <thead>
                    <tr>
                      <th>Patient Name</th>
                      <th>DOB</th>
                      <th>Scheduled</th>
                      <th>Screened</th>
                      <th>Tested</th>
                      <th>Cancelled</th>
                      <th>No Show</th>
                      <th>Safety Kit</th>                      
                      <th>Follow Up</th>
                      <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <% @clinic.patients.each do |patient| %>
                      <tr class="patient-row" data-target="clinic-activity-patients.searchableRow" data-search-content="<%= [patient.first_name.downcase, patient.last_name.downcase].join(" ") %>" data-patient-id="<%= patient.id %>">
                        <td>
                          <%= link_to patient.first_name + ' ' + patient.last_name, patient %> <br/>
                        </td>
                        <td><%= patient.date_of_birth.strftime("%D") %></td>
                        <td><%= patient.appointment_time %></td>
                        <% ["Screened", "Tested", "Cancelled", "No Show"].each do |outcome| %>
                          <td><%= radio_button_tag "outcome-#{patient.id}", outcome, (patient.event_for_clinic(@clinic).outcome == outcome), data: {action: "clinic-activity-patients#showModal", selection: outcome} %></td>
                        <% end %>
                        
                        
                        <td><%= check_box("safety_kit", {}) %></td>
                        <td><%= link_to "Remark", "#", class: "remark-link" %></td>
                        <td>
                          <div class="flex">
                            <%= link_to "Delete", "#", class: "table-actions" %>
                          </div>
                        </td>
                      </tr>
                    <% end %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="button-container">
            <input type="submit" name="save" value="Save" class="submit-button mr-2 mt-10">
            <input type="submit" name="save-submit" value="Save and Submit" class="submit-button ml-2 bg-blue-500 text-white mt-10">
          </div>
        <% end %>
      </div>
    </div>
</div>


<% @clinic.patients.each do |patient| %>
    <!-- First Modal -->
  <div data-target="clinic-activity-patients.modal" id="clinic-activity-modal-Screened-<%= patient.id %>" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center">
    <div class="modal-overlay fixed w-full h-full bg-black opacity-25 top-0 left-0 cursor-pointer"></div>
    <div class="absolute w-2/3 p-8 bg-white rounded-lg shadow-lg flex">

      <div class="w-1/3"> 
        <h1 class="text-lg leading-6 font-medium text-gray-900">
          Screened: <span class="font-bold"> <%= patient.full_name %> </span>
        </h1>
      </div>

      <div class="w-2/3">
        <%= form_with model: patient.event_for_clinic(@clinic), local: true do |f| %>
            <div class="mt-6 sm:mt-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:border-t sm:border-gray-200 sm:pt-5">
                <p class="block text-sm font-medium leading-5 text-gray-700 sm:mt-px sm:pt-2">
                    Contact Type
                </p>
                <div class="mt-1 sm:mt-0 sm:col-span-2">
                    <div class="max-w-xs rounded-md shadow-sm">
                        <%= f.select :contact_type, options_for_select(["In Person", "Telephone", "Electronic", "Other"], f.object.screening_outcome), {}, class: "block form-select w-full transition duration-150 ease-in-out sm:text-sm sm:leading-5" %>
                    </div>
                </div>
            </div>

            <div class="mt-6 sm:mt-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:border-t sm:border-gray-200 sm:pt-5">
                <p class="block text-sm font-medium leading-5 text-gray-700 sm:mt-px sm:pt-2">
                    Screening Outcome
                </p>
                <div class="mt-1 sm:mt-0 sm:col-span-2">
                    <div class="max-w-xs rounded-md shadow-sm">
                        <%= f.select :screening_outcome, options_for_select(["Low Risk", "Moderate Risk", "Refer for Testing", "Other"], f.object.screening_outcome), {}, class: "block form-select w-full transition duration-150 ease-in-out sm:text-sm sm:leading-5" %>
                    </div>
                </div>
            </div>

            <div class="mt-6 sm:mt-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:border-t sm:border-gray-200 sm:pt-5">
                <p class="block text-sm font-medium leading-5 text-gray-700 sm:mt-px sm:pt-2">
                    Tester
                </p>
                <div class="mt-1 sm:mt-0 sm:col-span-2">
                    <div class="max-w-xs rounded-md shadow-sm">
                        <%= f.select :clinic_staff_id, options_from_collection_for_select(@clinic.clinic_personnel, 'id', 'name', f.object.clinic_staff_id), {}, class: "block form-select w-full transition duration-150 ease-in-out sm:text-sm sm:leading-5" %>
                    </div>
                </div>
            </div>

            <div class="mt-6 sm:mt-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:border-t sm:border-gray-200 sm:pt-5">
                <p class="block text-sm font-medium leading-5 text-gray-700 sm:mt-px sm:pt-2">
                    Notes
                </p>
                <div class="mt-1 sm:mt-0 sm:col-span-2">
                    <div class="max-w-lg flex rounded-md shadow-sm">
                        <%= f.text_area :notes, rows: "3", class: "form-textarea block w-full transition duration-150 ease-in-out sm:text-sm sm:leading-5" %>
                    </div>
                </div>
            </div>
    
          <%# f.select :outcome, options_for_select(["Screened", "Tested", "Cancelled", "No Show"], f.object.outcome),{}, class: "form-select rounded m-1" %>
          <%= f.hidden_field :clinic_id %>
          <%= f.hidden_field :patient_id %>
          <%= f.hidden_field :outcome, value: "Screened"  %>

          
        <div class="mt-8 border-t border-gray-200 pt-5">
            <div class="flex justify-end">
                <span class="inline-flex rounded-md shadow-sm">
                    <a href="#" onClick="this.closest('.modal').classList.toggle('opacity-0');" class="py-2 px-4 border border-gray-300 rounded-md text-sm leading-5 font-medium text-gray-700 hover:text-gray-500 focus:outline-none focus:border-blue-300 focus:shadow-outline-blue active:bg-gray-50 active:text-gray-800 transition duration-150 ease-in-out">Cancel</a>
                </span>
                <% if f.object.new_record? %>
                    <span class="ml-3 inline-flex rounded-md shadow-sm">
                        <%= f.submit "Create Record", class: "inline-flex justify-center py-2 px-4 border border-transparent text-sm leading-5 font-medium rounded-md text-white bg-brand-red-500 hover:bg-red-500 focus:outline-none focus:border-red-700 focus:shadow-outline-red active:bg-red-500 transition duration-150 ease-in-out" %>
                    </span>
                <% else %>
                    <span class="inline-flex rounded-md shadow-sm">
                        <%= f.submit "Update Record", data: {confirm: "Are you sure you want to update the previously entered information for this patient?"}, class: "inline-flex justify-center py-2 px-4 border border-transparent text-sm leading-5 font-medium rounded-md text-white bg-brand-red-500 hover:bg-red-500 focus:outline-none focus:border-red-700 focus:shadow-outline-red active:bg-red-500 transition duration-150 ease-in-out" %>
                    </span>
                <% end %>
            </div>
        </div>
        <% end %>
      </div>
    </div>
  </div>
    
    <!-- Second Modal -->
   <div data-target="clinic-activity-patients.modal" id="clinic-activity-modal-Tested-<%= patient.id %>" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center">
    <div class="modal-overlay fixed w-full h-full bg-black opacity-25 top-0 left-0 cursor-pointer"></div>
    <div class="absolute w-2/3 p-8 bg-white rounded-sm shadow-lg flex">

      <div class="w-1/3"> 
        <h1 class="text-lg leading-6 font-medium text-gray-900">
          Tested: <span class="font-bold"> <%= patient.full_name %> </span>
        </h1>
    </div>
      <br/>
      <div class="w-2/3">
        <%= form_with model: patient.event_for_clinic(@clinic), local: true do |f| %>
            <div class="mt-6 sm:mt-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:border-t sm:border-gray-200 sm:pt-5">
                <p class="block text-sm font-medium leading-5 text-gray-700 sm:mt-px sm:pt-2">
                    Test Name
                </p>
                <div class="mt-1 sm:mt-0 sm:col-span-2">
                    <div class="max-w-xs rounded-md shadow-sm">
                    <%= f.select :test_name, options_for_select(["Fluzone", "Flu Test One", "Flu Test Two"], f.object.test_name), {}, class: "block form-select w-full transition duration-150 ease-in-out sm:text-sm sm:leading-5" %>
                    </div>
                </div>
            </div>

            <div class="mt-6 sm:mt-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:border-t sm:border-gray-200 sm:pt-5">
                <p class="block text-sm font-medium leading-5 text-gray-700 sm:mt-px sm:pt-2">
                    Test Type
                </p>
                <div class="mt-1 sm:mt-0 sm:col-span-2">
                    <div class="max-w-xs rounded-md shadow-sm">
                    <%= f.select :test_type, options_for_select(["PCR", "Blood"], f.object.test_type), {}, class: "block form-select w-full transition duration-150 ease-in-out sm:text-sm sm:leading-5" %>
                    </div>
                </div>
            </div>

            <div class="mt-6 sm:mt-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:border-t sm:border-gray-200 sm:pt-5">
                <p class="block text-sm font-medium leading-5 text-gray-700 sm:mt-px sm:pt-2">
                    Test Processing
                </p>
                <div class="mt-1 sm:mt-0 sm:col-span-2">
                    <div class="max-w-xs rounded-md shadow-sm">
                    <%= f.select :test_processing, options_for_select(["Standard", "Rapid"], f.object.test_processing), {}, class: "block form-select w-full transition duration-150 ease-in-out sm:text-sm sm:leading-5" %>
                    </div>
                </div>
            </div>

            <div class="mt-6 sm:mt-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:border-t sm:border-gray-200 sm:pt-5">
                <p class="block text-sm font-medium leading-5 text-gray-700 sm:mt-px sm:pt-2">
                    Tester
                </p>
                <div class="mt-1 sm:mt-0 sm:col-span-2">
                    <div class="max-w-xs rounded-md shadow-sm">
                    <%= f.select :clinic_staff_id, options_from_collection_for_select(@clinic.clinic_personnel, 'id', 'name', f.object.clinic_staff_id), {}, class: "block form-select w-full transition duration-150 ease-in-out sm:text-sm sm:leading-5" %>
                    </div>
                </div>
            </div>

            <div class="mt-6 sm:mt-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:border-t sm:border-gray-200 sm:pt-5">
                <p class="block text-sm font-medium leading-5 text-gray-700 sm:mt-px sm:pt-2">
                    Notes
                </p>
                <div class="mt-1 sm:mt-0 sm:col-span-2">
                    <div class="max-w-lg flex rounded-md shadow-sm">
                        <%= f.text_area :notes, rows: "3", class: "form-textarea block w-full transition duration-150 ease-in-out sm:text-sm sm:leading-5" %>
                    </div>
                </div>
            </div>
          <%= f.hidden_field :clinic_id %>
          <%= f.hidden_field :patient_id %>
          <%= f.hidden_field :outcome, value: "Tested"  %>

        <div class="mt-8 border-t border-gray-200 pt-5">
            <div class="flex justify-end">
                <span class="inline-flex rounded-md shadow-sm">
                    <a href="#" onClick="this.closest('.modal').classList.toggle('opacity-0');" class="py-2 px-4 border border-gray-300 rounded-md text-sm leading-5 font-medium text-gray-700 hover:text-gray-500 focus:outline-none focus:border-blue-300 focus:shadow-outline-blue active:bg-gray-50 active:text-gray-800 transition duration-150 ease-in-out">Cancel</a>
                </span>
                <% if f.object.new_record? %>
                    <span class="ml-3 inline-flex rounded-md shadow-sm">
                        <%= f.submit "Create Record", class: "inline-flex justify-center py-2 px-4 border border-transparent text-sm leading-5 font-medium rounded-md text-white bg-brand-red-500 hover:bg-red-500 focus:outline-none focus:border-red-700 focus:shadow-outline-red active:bg-brand-red-500 hover:bg-red-500 transition duration-150 ease-in-out" %>
                    </span>
                <% else %>
                    <span class="inline-flex rounded-md shadow-sm">
                        <%= f.submit "Update Record", data: {confirm: "Are you sure you want to update the previously entered information for this patient?"}, class: "inline-flex justify-center py-2 px-4 border border-transparent text-sm leading-5 font-medium rounded-md text-white bg-brand-red-500 hover:bg-red-500 focus:outline-none focus:border-red-700 focus:shadow-outline-red active:bg-red-500 transition duration-150 ease-in-out" %>
                    </span>
                <% end %>
            </div>
        </div>
        <% end %>
      </div>
    </div>
  </div>
 
<% end %>