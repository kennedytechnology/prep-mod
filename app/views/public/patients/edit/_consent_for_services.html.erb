<div class="border-2 border-green-500 bg-green-100 p-4 mb-8"> 
    <h2 class="text-lg mb-1 font-bold"> Share Your COVID-19 Results With Your Provider, School, or Employer </h2>
    <p class="mb-2 ml-2">
        <label class="text-base text-black">
            <%= f.check_box :sharing_results_authorized %>
            I authorize the following to access the results of ONLY my COVID-19 screening, testing, or vaccination services.
        </label>
    </p>

    <p class="italic"> 
        If you have questions about COVID-19, please contact your doctor, 
        local health department, or go to 
        <%= link_to "www.cdc.gov/coronavirus", "www.cdc.gov/coronavirus", class: "underline", target: "_blank" %>
    </p>
</div>


<div class="field-fullwidth mt-8" data-controller="consent-form">
    <p class="label"> With who would you like to share your information? (Select all that apply) </p>
    <p data-target="consent-form.companyInputField" class="text-xl">Selected: <%= @patient.employers.collect(&:company_name).join(", ")%></p>
    <div class="multiselect-dropdown">
        <div class="selectBox" data-action="click->consent-form#showCheckboxes">
            <input type="text" id="predict_company_name" data-action="keyup->consent-form#search" placeholder="Search company name" class="form-input w-1/3" style="height: 50px;" />
        </div>
        <div class="checkboxes-in-dropdown w-1/3" id="locationsCheckboxes" data-target="consent-form.locationsCheckboxes">
            <%= collection_check_boxes(:patient, :employer_ids, Employer.all, :id, :company_name) do |b| %>
                <div class="relative flex items-start px-3 hover:bg-blue-50" data-target="consent-form.searchableRow" data-search-content="<%= [b.object.company_name.try(:downcase)] %>">
                    <div class="absolute flex items-center h-5">
                        <%= b.check_box(class: "form-checkbox cursor-pointer text-base", 
                            data: {action: "click->consent-form#displayLocations", 
                            locations: "#{b.object.business_locations.join(", ")}",
                            employer: "#{b.object.company_name}",
                            target: "consent-form.companyCheckbox"
                            }) %> 
                    </div>
                    <div class="pl-6 text-sm leading-5">
                        <%= b.label %>
                    </div>
                </div>
            <% end %>
            <%= render "public/patients/business_locations_modal" %>
        </div>
    </div>
</div>



<div class="border-2 border-blue-500 bg-blue-100 p-4 mb-2"> 
    <p class="font-bold"> Consent for COVID-19 Testing - You Must Sign This to be Tested </p>
    <div class="text-gray-600 py-4 rounded"> 
        <p> By signing this form, I give permission for a COVID-19 test to be administered and a 
            record of the test and results be entered into a database for use to monitor control of the disease.
            Further, I agree that the information above is correct, and:</p>
        <ol class="list-disc ml-8 mt-2">
            <li> I have read information about the test or someone has explained it to me; </li>
            <li> I understand the risks and benefits of being tested and consent to be tested, and </li>
            <li> Any questions I had about the test have been answered. </li>
        </ol>
    </div>
</div>

<div class="flex w-full mb-5" data-controller="consent-form-signature">
    <div class="w-10/12">
        <p class="mt-10 font-semibold" data-target="consent-form-signature.title"> Please sign here with your finger or mouse </p>
        <div class="border border-gray-400 mt-2 mb-4 w-1/2 h-40" data-target="consent-form-signature.signatureInput">
            <canvas style="width:100%; height: 100%;"></canvas>
        </div>
        <%= f.hidden_field :signature_data, id: "hidden_signature_data" %>

        <div class="hidden w-8/12 mt-2 mb-4" data-target="consent-form-signature.fullName">
            <div class="h-40">
                <%= f.text_field :signatory_first_name, placeholder: "First Name", class: "w-10/12 form-input" %>
                <%= f.text_field :signatory_last_name, placeholder: "Last Name", class: "w-10/12 form-input" %>
            </div>
        </div>

        <div class="w-1/2 flex flex-col justify-end items-end">
            <div class="button-primary" 
                data-action="click->consent-form-signature#toggleSignature"
                data-target="consent-form-signature.buttonTitle"> Sign by typing my full name </div>
        </div>
    </div>
    <div class="flex flex-wrap content-end">
        <p><%= f.label :consent_date, "Date", class: "label" %></p>
        <%= text_field_tag "", Date.today.strftime("%m/%d/%y"), readonly: true, class: "form-input cursor-not-allowed bg-gray-200 text-gray-600" %>
        <%= f.hidden_field :consent_date, value: Date.today.strftime("%d-%m-%Y") %>
    </div>
</div>

<%# TODO: Move this into the proper place. %>
<script>
    var canvas = document.querySelector("canvas");
    var ratio =  Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);
    var signaturePad = new SignaturePad(canvas);
    var hidden_field = document.getElementById("hidden_signature_data")
    var parent_form = canvas.closest('form')
    parent_form.onsubmit = function() {
        hidden_field.value = signaturePad.toDataURL()
    }
    signaturePad.fromDataURL("<%= @patient.signature_data %>")
    
</script>

<div class="field-fullwidth">
    <div class="w-3/12">
        <%= f.label :relation_to_patient_for_insurance, "Relationship to Patient", class: "block" %>
        <%= f.select :relation_to_patient_for_insurance, ["Self","Parent/Guardian","Other"], {}, {class: "form-select w-full"} %>
    </div>
</div>

<%# hidden_field_tag :next_step, "appointment" %>
